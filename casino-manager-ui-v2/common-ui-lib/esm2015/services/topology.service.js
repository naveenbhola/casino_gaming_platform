import { EventEmitter, Injectable } from '@angular/core';
import { forkJoin } from 'rxjs';
import { HttpClient, HttpParams } from '@angular/common/http';
import { urls } from '../constants/urls';
import { TopologytreeService } from './topologytree.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./topologytree.service";
export class TopologyService {
    constructor(http, treeService) {
        this.http = http;
        this.treeService = treeService;
        this.accessGroupParams = new HttpParams().set('groupType', 'ACCESS');
        this.virtualGroupParams = new HttpParams().set('groupType', 'VIRTUAL');
        this.initialized = new EventEmitter();
        this.nodeClicked = new EventEmitter();
        this.terminalClicked = new EventEmitter();
        this.areasLabelClicked = new EventEmitter();
        this.nodeUpdated = new EventEmitter();
        this.nodeDragged = new EventEmitter();
        this.initTopology();
    }
    initTopology() {
        //Need To Fix
        if (!this.topologyTypes && !this.topologyNodes && !this.accessGroupNodes) {
            //GR-3058 changes.authValues clientId
            const authValues = JSON.parse(localStorage.getItem('authValues'));
            if (!authValues) {
                this.fetchTopologyData();
            }
            else {
                if (authValues && authValues.clientId !== 'lgn') {
                    this.fetchTopologyData();
                }
            }
        }
        // if (!this.virtualGroupNodes) {
        //     this.fetchTopologyDataWithVG();
        // }
    }
    fetchTopologyData() {
        forkJoin(this.getTopologyType({}), this.treeService.getTopologyNodes(urls.topologyTree.topologyTreeNodesUrl), this.treeService.getAccessOrVirtualGroupNodes(urls.topologyTree.accessGroupNodesUrl, this.accessGroupParams))
            .subscribe((result) => {
            this.topologyTypes = this.simplifyTopologyTypes(result[0]);
            this.topologyNodes = result[1];
            this.topologyNodeNames = this.createNodeNamesObject(result[1]);
            this.siteChildren = this.getSiteChildren(this.topologyNodeNames);
            // this.getCompanyNodeId();
            this.accessGroupNodes = result[2];
            if (result.length > 0) {
                this.initialized.next('nodesInitialized');
            }
        });
    }
    // fetchTopologyDataWithVG() {
    //     forkJoin(
    //         this.getTopologyType({}),
    //         this.treeService.getTopologyNodes(urls.topologyTree.topologyTreeNodesUrl),
    //         this.treeService.getAccessOrVirtualGroupNodes(urls.topologyTree.accessGroupNodesUrl, this.virtualGroupParams))
    //         .subscribe((result) => {
    //             //console.log(' fetchTopologyDataWithVGfork join result', JSON.stringify(result));
    //             this.topologyTypes = this.simplifyTopologyTypes(result[0]);
    //             this.topologyNodes = result[1];
    //             //console.log("this.topologyNodes"+JSON.stringify(this.topologyNodes))
    //             this.topologyNodeNames = this.createNodeNamesObject(result[1]);
    //             //this.getCompanyNodeId();
    //             this.siteChildren = this.getSiteChildren(this.topologyNodeNames);
    //             this.virtualGroupNodes = result[2];
    //             if (result.length > 0) {
    //                 this.initialized.next('nodesInitializedWithVg');
    //             }
    //         });
    // }
    // getCompanyNodeId(){
    //     for (const key in this.topologyNodeNames){
    //         if (this.topologyNodeNames[key].type === 100){
    //             this.companyNode = {
    //                 "nodeId": this.topologyNodeNames[key].nodeId,
    //                 "name": this.topologyNodeNames[key].name,
    //                 "shortName": this.topologyNodeNames[key].shortName
    //             }
    //                 this.topologyNodeNames[key].nodeId;
    //             console.log("this.companyNode "+JSON.stringify(this.companyNode ))
    //         }
    //     }
    // }
    getAccessGroup(options) {
        const url = `${urls.topology.topologyGroups}`;
        return this.http.get(url, options);
    }
    getTopologyType(options) {
        return this.http.get(urls.topology.topologyTypes, options);
    }
    getTopologyNodes(options) {
        return this.http.get(urls.topology.topologyNodes, options);
    }
    getTopologyPits(options) {
        const url = `${urls.topology.topologyNodes}?typeId=400`;
        return this.http.get(url, options);
    }
    getTablesByPitId(pitId, options) {
        const url = `${urls.topology.topologyNodes}?parentId=${pitId}`;
        return this.http.get(url, options);
    }
    updateTopologyNode(nodeId, params) {
        const url = `${urls.topologyTree.topologyNodesUrls}${nodeId}`;
        return this.http.post(url, params);
    }
    updateTopologyNodeStatus(nodeId, params) {
        const url = `${urls.topologyTree.topologyNodesUrls}${nodeId}`;
        return this.http.put(url, params);
    }
    createNodeOnTree(params) {
        const url = `${urls.topologyTree.topologyNodesUrls}`;
        return this.http.post(url, params);
    }
    createNodeAccessGroup(params) {
        const url = `${urls.topologyTree.accessGroupNodesUrl}`;
        return this.http.post(url, params);
    }
    updateAccessGroupNode(groupId, params) {
        const url = `${urls.topologyTree.accessGroupNodesUrl}${groupId}`;
        return this.http.put(url, params);
    }
    deleteAccessGroupNode(groupId, params) {
        const url = `${urls.topologyTree.accessGroupNodesUrl}${groupId}`;
        return this.http.delete(url, params);
    }
    getAccessGroupUsers(groupId, options) {
        const url = `${urls.user.usersPath}?topologyGroup=${groupId}`;
        return this.http.get(url, options);
    }
    getTableProperties(topologyId, options) {
        const tablePropertiesArr = ['com.wdts.table.num.player.positions', 'com.wdts.table.rfid.enabled', 'com.wdts.table.lucky6.enabled', 'com.wdts.table.lucky6.antenna'];
        const url = `${urls.config.configurations}devices?topologyId=${topologyId}&propertyCodes=${tablePropertiesArr}&templateTypeCode=BACCARAT`;
        return this.http.get(url, options);
    }
    // getCurrentGamingDay(topologyId): Observable<HttpResponse<Object>> {
    //     const url = `${urls.cage.localGamingDay}?topologyId=${topologyId}`;
    //     console.log("topology service"+url)
    //     return this.http.get<HttpResponse<Object>>(url);
    // }
    createNodeNamesObject(nodesData) {
        const namesObj = {};
        for (const obj in nodesData) {
            if (nodesData.hasOwnProperty(obj) && nodesData[obj].length > 0) {
                for (let i = 0, len = nodesData[obj].length; i < len; i++) {
                    namesObj[nodesData[obj][i].nodeId] = nodesData[obj][i];
                }
            }
        }
        return namesObj;
    }
    simplifyTopologyTypes(typesArr) {
        const typesMap = new Map();
        for (const obj in typesArr) {
            if (typesArr.hasOwnProperty(obj)) {
                typesMap.set(typesArr[obj].topologyTypeId, typesArr[obj]);
            }
        }
        return typesMap;
    }
    getSiteChildren(nodeNames) {
        const keysArr = Object.keys(nodeNames);
        const allKeys = [];
        for (let i = 0, iLen = keysArr.length; i < iLen; i++) {
            allKeys.push(parseInt(keysArr[i], 10));
        }
        let sites;
        sites = this.getSites(nodeNames);
        const siteKeys = [];
        for (const a in sites) {
            if (sites.hasOwnProperty(a)) {
                siteKeys.push(sites[a].id);
            }
        }
        for (const obj in sites) {
            if (sites.hasOwnProperty(obj)) {
                sites[obj].children = this.getChildren(sites[obj], nodeNames);
            }
        }
        return sites;
    }
    getSites(nodeNames) {
        const nodes = nodeNames;
        const sites = {};
        for (const node in nodes) {
            if (nodes.hasOwnProperty(node) && nodes[node].type === 150) {
                const nodeObj = { id: 'number', children: [] };
                nodeObj.id = nodes[node].nodeId;
                nodeObj.children = [];
                sites[nodes[node].name] = nodeObj;
            }
        }
        return sites;
    }
    getChildren(siteObj, nodeNames) {
        let childrenArr = [];
        for (const obj in nodeNames) {
            if (siteObj.id === nodeNames[obj].parentNodeId) {
                childrenArr.push(nodeNames[obj].nodeId);
            }
        }
        childrenArr = this.getOtherChildren(childrenArr, nodeNames);
        return childrenArr;
    }
    getOtherChildren(childrenArr, nodeNames) {
        for (const obj in nodeNames) {
            for (let i = 0, iLen = childrenArr.length; i < iLen; i++) {
                if (childrenArr[i] === nodeNames[obj].parentNodeId) {
                    if (!(childrenArr.indexOf(nodeNames[obj].nodeId) > -1)) {
                        childrenArr.push(nodeNames[obj].nodeId);
                    }
                }
            }
        }
        childrenArr = this.getAllChildren(childrenArr);
        return childrenArr;
    }
    getAllChildren(childrenArr) {
        const nodeKeys = Object.keys(this.topologyNodes);
        const keysArr = [];
        for (let i = 0, iLen = nodeKeys.length; i < iLen; i++) {
            keysArr.push(parseInt(nodeKeys[i], 10));
        }
        for (const a in childrenArr) {
            if (keysArr.indexOf(childrenArr[a]) > -1) {
                const childrenOfNode = this.topologyNodes[childrenArr[a]];
                for (let i = 0, iLen = childrenOfNode.length; i < iLen; i++) {
                    if (childrenArr.indexOf(childrenOfNode[i].nodeId) === -1) {
                        childrenArr.push(childrenOfNode[i].nodeId);
                    }
                }
            }
        }
        for (const b in childrenArr) {
            if (keysArr.indexOf(childrenArr[b]) > -1) {
                const allChildren = this.topologyNodes[childrenArr[b]];
                for (let i = 0, iLen = allChildren.length; i < iLen; i++) {
                    if (childrenArr.indexOf(allChildren[i].nodeId) === -1) {
                        childrenArr.push(allChildren[i].nodeId);
                    }
                }
            }
        }
        return childrenArr;
    }
    createVirtualGroup(node) {
        const url = `${urls.topology.topologyGroups}`;
        return this.http.post(url, node);
    }
    updateVirtualGroup(groupId, object) {
        const url = `${urls.topology.topologyGroups}${groupId}`;
        return this.http.put(url, object);
    }
    deleteVirtualGroup(groupId, object) {
        const url = `${urls.topology.topologyGroups}${groupId}`;
        return this.http.delete(url, object);
    }
    getVirtualGroups(userId) {
        const url = `${urls.topology.virtualGroupNodesUrl}${userId}`;
        return this.http.get(url);
    }
}
TopologyService.ɵprov = i0.ɵɵdefineInjectable({ factory: function TopologyService_Factory() { return new TopologyService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.TopologytreeService)); }, token: TopologyService, providedIn: "root" });
TopologyService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
TopologyService.ctorParameters = () => [
    { type: HttpClient },
    { type: TopologytreeService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9wb2xvZ3kuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2NvbW1vbi11aS12Mi9zcmMvYXBwL3NlcnZpY2VzL3RvcG9sb2d5LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFlBQVksRUFBRSxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDdkQsT0FBTyxFQUFDLFFBQVEsRUFBYSxNQUFNLE1BQU0sQ0FBQztBQUMxQyxPQUFPLEVBQUMsVUFBVSxFQUFFLFVBQVUsRUFBZSxNQUFNLHNCQUFzQixDQUFDO0FBQzFFLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUV2QyxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQzs7OztBQUszRCxNQUFNLE9BQU8sZUFBZTtJQW1CeEIsWUFBb0IsSUFBZ0IsRUFDaEIsV0FBZ0M7UUFEaEMsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNoQixnQkFBVyxHQUFYLFdBQVcsQ0FBcUI7UUFWcEQsc0JBQWlCLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2hFLHVCQUFrQixHQUFHLElBQUksVUFBVSxFQUFFLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUNsRSxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDakMsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ2pDLG9CQUFlLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNyQyxzQkFBaUIsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ3ZDLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNqQyxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFJekIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBRTVC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LENBQUMsSUFBSSxDQUFDLElBQUksQ0FBdUIsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFFRCxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsTUFBTTtRQUM5QixNQUFNLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxHQUFHLE9BQU8sRUFBRSxDQUFDO1FBQ3hELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQXVCLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRUQsa0JBQWtCLENBQUMsT0FBTyxFQUFFLE1BQU07UUFDOUIsTUFBTSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsR0FBRyxPQUFPLEVBQUUsQ0FBQztRQUN4RCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUF1QixHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDL0QsQ0FBQztJQUVELGdCQUFnQixDQUFDLE1BQU07UUFDbkIsTUFBTSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLG9CQUFvQixHQUFHLE1BQU0sRUFBRSxDQUFDO1FBQzdELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQXVCLEdBQUcsQ0FBQyxDQUFDO0lBQ3BELENBQUM7Ozs7WUExU0osVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7WUFQTyxVQUFVO1lBR1YsbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtFdmVudEVtaXR0ZXIsIEluamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtmb3JrSm9pbiwgT2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XG5pbXBvcnQge0h0dHBDbGllbnQsIEh0dHBQYXJhbXMsIEh0dHBSZXNwb25zZX0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHt1cmxzfSBmcm9tICcuLi9jb25zdGFudHMvdXJscyc7XG5pbXBvcnQge1RvcG9sb2d5Tm9kZUludGVyZmFjZSwgVG9wb2xvZ3lUeXBlc0ludGVyZmFjZX0gZnJvbSAnLi4vaW50ZXJmYWNlL3RvcG9sb2d5LXR5cGVzLmludGVyZmFjZSc7XG5pbXBvcnQge1RvcG9sb2d5dHJlZVNlcnZpY2V9IGZyb20gJy4vdG9wb2xvZ3l0cmVlLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFRvcG9sb2d5U2VydmljZSB7XG4gICAgdG9wb2xvZ3lUeXBlcztcbiAgICB0b3BvbG9neU5vZGVzO1xuICAgIHRvcG9sb2d5Tm9kZU5hbWVzO1xuICAgIC8vY29tcGFueU5vZGU7XG4gICAgc2l0ZUNoaWxkcmVuO1xuICAgIGFjY2Vzc0dyb3VwTm9kZXM7XG4gICAgdmlydHVhbEdyb3VwTm9kZXM7XG4gICAgdW5Bc3NpZ25lZE5vZGVzO1xuICAgIHVuYXNzaWduZWROb2Rlc0FycjtcbiAgICBhY2Nlc3NHcm91cFBhcmFtcyA9IG5ldyBIdHRwUGFyYW1zKCkuc2V0KCdncm91cFR5cGUnLCAnQUNDRVNTJyk7XG4gICAgdmlydHVhbEdyb3VwUGFyYW1zID0gbmV3IEh0dHBQYXJhbXMoKS5zZXQoJ2dyb3VwVHlwZScsICdWSVJUVUFMJyk7XG4gICAgaW5pdGlhbGl6ZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgbm9kZUNsaWNrZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgdGVybWluYWxDbGlja2VkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIGFyZWFzTGFiZWxDbGlja2VkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIG5vZGVVcGRhdGVkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIG5vZGVEcmFnZ2VkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICAgICAgICAgICAgICAgIHByaXZhdGUgdHJlZVNlcnZpY2U6IFRvcG9sb2d5dHJlZVNlcnZpY2UpIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdFRvcG9sb2d5KCk7XG5cbiAgICB9XG5cbiAgICBpbml0VG9wb2xvZ3koKSB7XG4gICAgICAgIC8vTmVlZCBUbyBGaXhcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnRvcG9sb2d5VHlwZXMgJiYgIXRoaXMudG9wb2xvZ3lOb2RlcyAmJiAhdGhpcy5hY2Nlc3NHcm91cE5vZGVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL0dSLTMwNTggY2hhbmdlcy5hdXRoVmFsdWVzIGNsaWVudElkXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdXRoVmFsdWVzID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnYXV0aFZhbHVlcycpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXV0aFZhbHVlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmV0Y2hUb3BvbG9neURhdGEoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF1dGhWYWx1ZXMgJiYgYXV0aFZhbHVlcy5jbGllbnRJZCAhPT0gJ2xnbicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mZXRjaFRvcG9sb2d5RGF0YSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgIC8vIGlmICghdGhpcy52aXJ0dWFsR3JvdXBOb2Rlcykge1xuICAgICAgICAvLyAgICAgdGhpcy5mZXRjaFRvcG9sb2d5RGF0YVdpdGhWRygpO1xuICAgICAgICAvLyB9XG4gICAgfVxuXG4gICAgZmV0Y2hUb3BvbG9neURhdGEoKSB7XG4gICAgICAgIGZvcmtKb2luKFxuICAgICAgICAgICAgdGhpcy5nZXRUb3BvbG9neVR5cGUoe30pLFxuICAgICAgICAgICAgdGhpcy50cmVlU2VydmljZS5nZXRUb3BvbG9neU5vZGVzKHVybHMudG9wb2xvZ3lUcmVlLnRvcG9sb2d5VHJlZU5vZGVzVXJsKSxcbiAgICAgICAgICAgIHRoaXMudHJlZVNlcnZpY2UuZ2V0QWNjZXNzT3JWaXJ0dWFsR3JvdXBOb2Rlcyh1cmxzLnRvcG9sb2d5VHJlZS5hY2Nlc3NHcm91cE5vZGVzVXJsLCB0aGlzLmFjY2Vzc0dyb3VwUGFyYW1zKSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMudG9wb2xvZ3lUeXBlcyA9IHRoaXMuc2ltcGxpZnlUb3BvbG9neVR5cGVzKHJlc3VsdFswXSk7XG4gICAgICAgICAgICAgICAgdGhpcy50b3BvbG9neU5vZGVzID0gcmVzdWx0WzFdO1xuICAgICAgICAgICAgICAgIHRoaXMudG9wb2xvZ3lOb2RlTmFtZXMgPSB0aGlzLmNyZWF0ZU5vZGVOYW1lc09iamVjdChyZXN1bHRbMV0pO1xuICAgICAgICAgICAgICAgIHRoaXMuc2l0ZUNoaWxkcmVuID0gdGhpcy5nZXRTaXRlQ2hpbGRyZW4odGhpcy50b3BvbG9neU5vZGVOYW1lcyk7XG4gICAgICAgICAgICAgICAgLy8gdGhpcy5nZXRDb21wYW55Tm9kZUlkKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5hY2Nlc3NHcm91cE5vZGVzID0gcmVzdWx0WzJdO1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmluaXRpYWxpemVkLm5leHQoJ25vZGVzSW5pdGlhbGl6ZWQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBmZXRjaFRvcG9sb2d5RGF0YVdpdGhWRygpIHtcbiAgICAvLyAgICAgZm9ya0pvaW4oXG4gICAgLy8gICAgICAgICB0aGlzLmdldFRvcG9sb2d5VHlwZSh7fSksXG4gICAgLy8gICAgICAgICB0aGlzLnRyZWVTZXJ2aWNlLmdldFRvcG9sb2d5Tm9kZXModXJscy50b3BvbG9neVRyZWUudG9wb2xvZ3lUcmVlTm9kZXNVcmwpLFxuICAgIC8vICAgICAgICAgdGhpcy50cmVlU2VydmljZS5nZXRBY2Nlc3NPclZpcnR1YWxHcm91cE5vZGVzKHVybHMudG9wb2xvZ3lUcmVlLmFjY2Vzc0dyb3VwTm9kZXNVcmwsIHRoaXMudmlydHVhbEdyb3VwUGFyYW1zKSlcbiAgICAvLyAgICAgICAgIC5zdWJzY3JpYmUoKHJlc3VsdCkgPT4ge1xuICAgIC8vICAgICAgICAgICAgIC8vY29uc29sZS5sb2coJyBmZXRjaFRvcG9sb2d5RGF0YVdpdGhWR2Zvcmsgam9pbiByZXN1bHQnLCBKU09OLnN0cmluZ2lmeShyZXN1bHQpKTtcbiAgICAvLyAgICAgICAgICAgICB0aGlzLnRvcG9sb2d5VHlwZXMgPSB0aGlzLnNpbXBsaWZ5VG9wb2xvZ3lUeXBlcyhyZXN1bHRbMF0pO1xuICAgIC8vICAgICAgICAgICAgIHRoaXMudG9wb2xvZ3lOb2RlcyA9IHJlc3VsdFsxXTtcbiAgICAvLyAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwidGhpcy50b3BvbG9neU5vZGVzXCIrSlNPTi5zdHJpbmdpZnkodGhpcy50b3BvbG9neU5vZGVzKSlcbiAgICAvLyAgICAgICAgICAgICB0aGlzLnRvcG9sb2d5Tm9kZU5hbWVzID0gdGhpcy5jcmVhdGVOb2RlTmFtZXNPYmplY3QocmVzdWx0WzFdKTtcbiAgICAvLyAgICAgICAgICAgICAvL3RoaXMuZ2V0Q29tcGFueU5vZGVJZCgpO1xuICAgIC8vICAgICAgICAgICAgIHRoaXMuc2l0ZUNoaWxkcmVuID0gdGhpcy5nZXRTaXRlQ2hpbGRyZW4odGhpcy50b3BvbG9neU5vZGVOYW1lcyk7XG4gICAgLy8gICAgICAgICAgICAgdGhpcy52aXJ0dWFsR3JvdXBOb2RlcyA9IHJlc3VsdFsyXTtcbiAgICAvLyAgICAgICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAvLyAgICAgICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplZC5uZXh0KCdub2Rlc0luaXRpYWxpemVkV2l0aFZnJyk7XG4gICAgLy8gICAgICAgICAgICAgfVxuICAgIC8vICAgICAgICAgfSk7XG4gICAgLy8gfVxuXG4gICAgLy8gZ2V0Q29tcGFueU5vZGVJZCgpe1xuICAgIC8vICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLnRvcG9sb2d5Tm9kZU5hbWVzKXtcbiAgICAvLyAgICAgICAgIGlmICh0aGlzLnRvcG9sb2d5Tm9kZU5hbWVzW2tleV0udHlwZSA9PT0gMTAwKXtcbiAgICAvLyAgICAgICAgICAgICB0aGlzLmNvbXBhbnlOb2RlID0ge1xuICAgIC8vICAgICAgICAgICAgICAgICBcIm5vZGVJZFwiOiB0aGlzLnRvcG9sb2d5Tm9kZU5hbWVzW2tleV0ubm9kZUlkLFxuICAgIC8vICAgICAgICAgICAgICAgICBcIm5hbWVcIjogdGhpcy50b3BvbG9neU5vZGVOYW1lc1trZXldLm5hbWUsXG4gICAgLy8gICAgICAgICAgICAgICAgIFwic2hvcnROYW1lXCI6IHRoaXMudG9wb2xvZ3lOb2RlTmFtZXNba2V5XS5zaG9ydE5hbWVcbiAgICAvLyAgICAgICAgICAgICB9XG4gICAgLy8gICAgICAgICAgICAgICAgIHRoaXMudG9wb2xvZ3lOb2RlTmFtZXNba2V5XS5ub2RlSWQ7XG4gICAgLy8gICAgICAgICAgICAgY29uc29sZS5sb2coXCJ0aGlzLmNvbXBhbnlOb2RlIFwiK0pTT04uc3RyaW5naWZ5KHRoaXMuY29tcGFueU5vZGUgKSlcbiAgICAvLyAgICAgICAgIH1cbiAgICAvLyAgICAgfVxuICAgIC8vIH1cblxuICAgIGdldEFjY2Vzc0dyb3VwKG9wdGlvbnM6IHt9KTogT2JzZXJ2YWJsZTxIdHRwUmVzcG9uc2U8T2JqZWN0Pj4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt1cmxzLnRvcG9sb2d5LnRvcG9sb2d5R3JvdXBzfWA7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PEh0dHBSZXNwb25zZTxPYmplY3Q+Pih1cmwsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGdldFRvcG9sb2d5VHlwZShvcHRpb25zOiB7fSk6IE9ic2VydmFibGU8VG9wb2xvZ3lUeXBlc0ludGVyZmFjZVtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PFRvcG9sb2d5VHlwZXNJbnRlcmZhY2VbXT4odXJscy50b3BvbG9neS50b3BvbG9neVR5cGVzLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICBnZXRUb3BvbG9neU5vZGVzKG9wdGlvbnM6IHt9KTogT2JzZXJ2YWJsZTxUb3BvbG9neU5vZGVJbnRlcmZhY2VbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5odHRwLmdldDxUb3BvbG9neU5vZGVJbnRlcmZhY2VbXT4odXJscy50b3BvbG9neS50b3BvbG9neU5vZGVzLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICBnZXRUb3BvbG9neVBpdHMob3B0aW9uczoge30pOiBPYnNlcnZhYmxlPEh0dHBSZXNwb25zZTxPYmplY3Q+PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3VybHMudG9wb2xvZ3kudG9wb2xvZ3lOb2Rlc30/dHlwZUlkPTQwMGA7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PEh0dHBSZXNwb25zZTxPYmplY3Q+Pih1cmwsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGdldFRhYmxlc0J5UGl0SWQocGl0SWQsIG9wdGlvbnM6IHt9KTogT2JzZXJ2YWJsZTxIdHRwUmVzcG9uc2U8T2JqZWN0Pj4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt1cmxzLnRvcG9sb2d5LnRvcG9sb2d5Tm9kZXN9P3BhcmVudElkPSR7cGl0SWR9YDtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQ8SHR0cFJlc3BvbnNlPE9iamVjdD4+KHVybCwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgdXBkYXRlVG9wb2xvZ3lOb2RlKG5vZGVJZCwgcGFyYW1zOiB7fSk6IE9ic2VydmFibGU8SHR0cFJlc3BvbnNlPE9iamVjdD4+IHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dXJscy50b3BvbG9neVRyZWUudG9wb2xvZ3lOb2Rlc1VybHN9JHtub2RlSWR9YDtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0PEh0dHBSZXNwb25zZTxPYmplY3Q+Pih1cmwsIHBhcmFtcyk7XG4gICAgfVxuXG4gICAgdXBkYXRlVG9wb2xvZ3lOb2RlU3RhdHVzKG5vZGVJZCwgcGFyYW1zOiB7fSk6IE9ic2VydmFibGU8SHR0cFJlc3BvbnNlPE9iamVjdD4+IHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dXJscy50b3BvbG9neVRyZWUudG9wb2xvZ3lOb2Rlc1VybHN9JHtub2RlSWR9YDtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wdXQ8SHR0cFJlc3BvbnNlPE9iamVjdD4+KHVybCwgcGFyYW1zKTtcbiAgICB9XG5cbiAgICBjcmVhdGVOb2RlT25UcmVlKHBhcmFtczoge30pOiBPYnNlcnZhYmxlPEh0dHBSZXNwb25zZTxPYmplY3Q+PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3VybHMudG9wb2xvZ3lUcmVlLnRvcG9sb2d5Tm9kZXNVcmxzfWA7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAucG9zdDxIdHRwUmVzcG9uc2U8T2JqZWN0Pj4odXJsLCBwYXJhbXMpO1xuICAgIH1cblxuICAgIGNyZWF0ZU5vZGVBY2Nlc3NHcm91cChwYXJhbXM6IHt9KTogT2JzZXJ2YWJsZTxIdHRwUmVzcG9uc2U8T2JqZWN0Pj4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt1cmxzLnRvcG9sb2d5VHJlZS5hY2Nlc3NHcm91cE5vZGVzVXJsfWA7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAucG9zdDxIdHRwUmVzcG9uc2U8T2JqZWN0Pj4odXJsLCBwYXJhbXMpO1xuICAgIH1cblxuICAgIHVwZGF0ZUFjY2Vzc0dyb3VwTm9kZShncm91cElkLCBwYXJhbXM6IHt9KTogT2JzZXJ2YWJsZTxIdHRwUmVzcG9uc2U8T2JqZWN0Pj4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt1cmxzLnRvcG9sb2d5VHJlZS5hY2Nlc3NHcm91cE5vZGVzVXJsfSR7Z3JvdXBJZH1gO1xuICAgICAgICByZXR1cm4gdGhpcy5odHRwLnB1dDxIdHRwUmVzcG9uc2U8T2JqZWN0Pj4odXJsLCBwYXJhbXMpO1xuICAgIH1cblxuICAgIGRlbGV0ZUFjY2Vzc0dyb3VwTm9kZShncm91cElkLCBwYXJhbXM6IHt9KTogT2JzZXJ2YWJsZTxIdHRwUmVzcG9uc2U8T2JqZWN0Pj4ge1xuICAgICAgICBjb25zdCB1cmwgPSBgJHt1cmxzLnRvcG9sb2d5VHJlZS5hY2Nlc3NHcm91cE5vZGVzVXJsfSR7Z3JvdXBJZH1gO1xuICAgICAgICByZXR1cm4gdGhpcy5odHRwLmRlbGV0ZTxIdHRwUmVzcG9uc2U8T2JqZWN0Pj4odXJsLCBwYXJhbXMpO1xuICAgIH1cblxuICAgIGdldEFjY2Vzc0dyb3VwVXNlcnMoZ3JvdXBJZCwgb3B0aW9uczoge30pOiBPYnNlcnZhYmxlPEh0dHBSZXNwb25zZTxPYmplY3Q+PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3VybHMudXNlci51c2Vyc1BhdGh9P3RvcG9sb2d5R3JvdXA9JHtncm91cElkfWA7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PEh0dHBSZXNwb25zZTxPYmplY3Q+Pih1cmwsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGdldFRhYmxlUHJvcGVydGllcyh0b3BvbG9neUlkLCBvcHRpb25zOiB7fSk6IE9ic2VydmFibGU8SHR0cFJlc3BvbnNlPE9iamVjdD4+IHtcbiAgICAgICAgY29uc3QgdGFibGVQcm9wZXJ0aWVzQXJyID0gWydjb20ud2R0cy50YWJsZS5udW0ucGxheWVyLnBvc2l0aW9ucycsICdjb20ud2R0cy50YWJsZS5yZmlkLmVuYWJsZWQnLCAnY29tLndkdHMudGFibGUubHVja3k2LmVuYWJsZWQnLCAnY29tLndkdHMudGFibGUubHVja3k2LmFudGVubmEnXTtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dXJscy5jb25maWcuY29uZmlndXJhdGlvbnN9ZGV2aWNlcz90b3BvbG9neUlkPSR7dG9wb2xvZ3lJZH0mcHJvcGVydHlDb2Rlcz0ke3RhYmxlUHJvcGVydGllc0Fycn0mdGVtcGxhdGVUeXBlQ29kZT1CQUNDQVJBVGA7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PEh0dHBSZXNwb25zZTxPYmplY3Q+Pih1cmwsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8vIGdldEN1cnJlbnRHYW1pbmdEYXkodG9wb2xvZ3lJZCk6IE9ic2VydmFibGU8SHR0cFJlc3BvbnNlPE9iamVjdD4+IHtcbiAgICAvLyAgICAgY29uc3QgdXJsID0gYCR7dXJscy5jYWdlLmxvY2FsR2FtaW5nRGF5fT90b3BvbG9neUlkPSR7dG9wb2xvZ3lJZH1gO1xuICAgIC8vICAgICBjb25zb2xlLmxvZyhcInRvcG9sb2d5IHNlcnZpY2VcIit1cmwpXG4gICAgLy8gICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PEh0dHBSZXNwb25zZTxPYmplY3Q+Pih1cmwpO1xuICAgIC8vIH1cbiAgICBjcmVhdGVOb2RlTmFtZXNPYmplY3Qobm9kZXNEYXRhKSB7XG4gICAgICAgIGNvbnN0IG5hbWVzT2JqID0ge307XG4gICAgICAgIGZvciAoY29uc3Qgb2JqIGluIG5vZGVzRGF0YSkge1xuICAgICAgICAgICAgaWYgKG5vZGVzRGF0YS5oYXNPd25Qcm9wZXJ0eShvYmopICYmIG5vZGVzRGF0YVtvYmpdLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gbm9kZXNEYXRhW29ial0ubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZXNPYmpbbm9kZXNEYXRhW29ial1baV0ubm9kZUlkXSA9IG5vZGVzRGF0YVtvYmpdW2ldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmFtZXNPYmo7XG4gICAgfVxuXG4gICAgc2ltcGxpZnlUb3BvbG9neVR5cGVzKHR5cGVzQXJyKSB7XG4gICAgICAgIGNvbnN0IHR5cGVzTWFwID0gbmV3IE1hcDxudW1iZXIsIG9iamVjdD4oKTtcbiAgICAgICAgZm9yIChjb25zdCBvYmogaW4gdHlwZXNBcnIpIHtcbiAgICAgICAgICAgIGlmICh0eXBlc0Fyci5oYXNPd25Qcm9wZXJ0eShvYmopKSB7XG4gICAgICAgICAgICAgICAgdHlwZXNNYXAuc2V0KHR5cGVzQXJyW29ial0udG9wb2xvZ3lUeXBlSWQsIHR5cGVzQXJyW29ial0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0eXBlc01hcDtcbiAgICB9XG5cbiAgICBnZXRTaXRlQ2hpbGRyZW4obm9kZU5hbWVzKSB7XG4gICAgICAgIGNvbnN0IGtleXNBcnIgPSBPYmplY3Qua2V5cyhub2RlTmFtZXMpO1xuICAgICAgICBjb25zdCBhbGxLZXlzID0gW107XG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBpTGVuID0ga2V5c0Fyci5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHtcbiAgICAgICAgICAgIGFsbEtleXMucHVzaChwYXJzZUludChrZXlzQXJyW2ldLCAxMCkpO1xuICAgICAgICB9XG4gICAgICAgIGxldCBzaXRlcztcbiAgICAgICAgc2l0ZXMgPSB0aGlzLmdldFNpdGVzKG5vZGVOYW1lcyk7XG4gICAgICAgIGNvbnN0IHNpdGVLZXlzID0gW107XG4gICAgICAgIGZvciAoY29uc3QgYSBpbiBzaXRlcykge1xuICAgICAgICAgICAgaWYgKHNpdGVzLmhhc093blByb3BlcnR5KGEpKSB7XG4gICAgICAgICAgICAgICAgc2l0ZUtleXMucHVzaChzaXRlc1thXS5pZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCBvYmogaW4gc2l0ZXMpIHtcbiAgICAgICAgICAgIGlmIChzaXRlcy5oYXNPd25Qcm9wZXJ0eShvYmopKSB7XG4gICAgICAgICAgICAgICAgc2l0ZXNbb2JqXS5jaGlsZHJlbiA9IHRoaXMuZ2V0Q2hpbGRyZW4oc2l0ZXNbb2JqXSwgbm9kZU5hbWVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gc2l0ZXM7XG4gICAgfVxuXG4gICAgZ2V0U2l0ZXMobm9kZU5hbWVzKSB7XG4gICAgICAgIGNvbnN0IG5vZGVzID0gbm9kZU5hbWVzO1xuICAgICAgICBjb25zdCBzaXRlcyA9IHt9O1xuICAgICAgICBmb3IgKGNvbnN0IG5vZGUgaW4gbm9kZXMpIHtcbiAgICAgICAgICAgIGlmIChub2Rlcy5oYXNPd25Qcm9wZXJ0eShub2RlKSAmJiBub2Rlc1tub2RlXS50eXBlID09PSAxNTApIHtcbiAgICAgICAgICAgICAgICBjb25zdCBub2RlT2JqID0ge2lkOiAnbnVtYmVyJywgY2hpbGRyZW46IFtdfTtcbiAgICAgICAgICAgICAgICBub2RlT2JqLmlkID0gbm9kZXNbbm9kZV0ubm9kZUlkO1xuICAgICAgICAgICAgICAgIG5vZGVPYmouY2hpbGRyZW4gPSBbXTtcbiAgICAgICAgICAgICAgICBzaXRlc1tub2Rlc1tub2RlXS5uYW1lXSA9IG5vZGVPYmo7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNpdGVzO1xuICAgIH1cblxuICAgIGdldENoaWxkcmVuKHNpdGVPYmosIG5vZGVOYW1lcykge1xuICAgICAgICBsZXQgY2hpbGRyZW5BcnIgPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCBvYmogaW4gbm9kZU5hbWVzKSB7XG4gICAgICAgICAgICBpZiAoc2l0ZU9iai5pZCA9PT0gbm9kZU5hbWVzW29ial0ucGFyZW50Tm9kZUlkKSB7XG4gICAgICAgICAgICAgICAgY2hpbGRyZW5BcnIucHVzaChub2RlTmFtZXNbb2JqXS5ub2RlSWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNoaWxkcmVuQXJyID0gdGhpcy5nZXRPdGhlckNoaWxkcmVuKGNoaWxkcmVuQXJyLCBub2RlTmFtZXMpO1xuICAgICAgICByZXR1cm4gY2hpbGRyZW5BcnI7XG4gICAgfVxuXG4gICAgZ2V0T3RoZXJDaGlsZHJlbihjaGlsZHJlbkFyciwgbm9kZU5hbWVzKSB7XG4gICAgICAgIGZvciAoY29uc3Qgb2JqIGluIG5vZGVOYW1lcykge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDAsIGlMZW4gPSBjaGlsZHJlbkFyci5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoY2hpbGRyZW5BcnJbaV0gPT09IG5vZGVOYW1lc1tvYmpdLnBhcmVudE5vZGVJZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIShjaGlsZHJlbkFyci5pbmRleE9mKG5vZGVOYW1lc1tvYmpdLm5vZGVJZCkgPiAtMSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuQXJyLnB1c2gobm9kZU5hbWVzW29ial0ubm9kZUlkKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjaGlsZHJlbkFyciA9IHRoaXMuZ2V0QWxsQ2hpbGRyZW4oY2hpbGRyZW5BcnIpO1xuICAgICAgICByZXR1cm4gY2hpbGRyZW5BcnI7XG4gICAgfVxuXG4gICAgZ2V0QWxsQ2hpbGRyZW4oY2hpbGRyZW5BcnIpIHtcbiAgICAgICAgY29uc3Qgbm9kZUtleXMgPSBPYmplY3Qua2V5cyh0aGlzLnRvcG9sb2d5Tm9kZXMpO1xuICAgICAgICBjb25zdCBrZXlzQXJyID0gW107XG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBpTGVuID0gbm9kZUtleXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7XG4gICAgICAgICAgICBrZXlzQXJyLnB1c2gocGFyc2VJbnQobm9kZUtleXNbaV0sIDEwKSk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCBhIGluIGNoaWxkcmVuQXJyKSB7XG4gICAgICAgICAgICBpZiAoa2V5c0Fyci5pbmRleE9mKGNoaWxkcmVuQXJyW2FdKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2hpbGRyZW5PZk5vZGUgPSB0aGlzLnRvcG9sb2d5Tm9kZXNbY2hpbGRyZW5BcnJbYV1dO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBpTGVuID0gY2hpbGRyZW5PZk5vZGUubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbkFyci5pbmRleE9mKGNoaWxkcmVuT2ZOb2RlW2ldLm5vZGVJZCkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbkFyci5wdXNoKGNoaWxkcmVuT2ZOb2RlW2ldLm5vZGVJZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCBiIGluIGNoaWxkcmVuQXJyKSB7XG4gICAgICAgICAgICBpZiAoa2V5c0Fyci5pbmRleE9mKGNoaWxkcmVuQXJyW2JdKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgYWxsQ2hpbGRyZW4gPSB0aGlzLnRvcG9sb2d5Tm9kZXNbY2hpbGRyZW5BcnJbYl1dO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBpTGVuID0gYWxsQ2hpbGRyZW4ubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbkFyci5pbmRleE9mKGFsbENoaWxkcmVuW2ldLm5vZGVJZCkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbkFyci5wdXNoKGFsbENoaWxkcmVuW2ldLm5vZGVJZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNoaWxkcmVuQXJyO1xuICAgIH1cblxuICAgIGNyZWF0ZVZpcnR1YWxHcm91cChub2RlKSB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3VybHMudG9wb2xvZ3kudG9wb2xvZ3lHcm91cHN9YDtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0PEh0dHBSZXNwb25zZTxPYmplY3Q+Pih1cmwsIG5vZGUpO1xuICAgIH1cblxuICAgIHVwZGF0ZVZpcnR1YWxHcm91cChncm91cElkLCBvYmplY3QpIHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dXJscy50b3BvbG9neS50b3BvbG9neUdyb3Vwc30ke2dyb3VwSWR9YDtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wdXQ8SHR0cFJlc3BvbnNlPE9iamVjdD4+KHVybCwgb2JqZWN0KTtcbiAgICB9XG5cbiAgICBkZWxldGVWaXJ0dWFsR3JvdXAoZ3JvdXBJZCwgb2JqZWN0KSB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke3VybHMudG9wb2xvZ3kudG9wb2xvZ3lHcm91cHN9JHtncm91cElkfWA7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAuZGVsZXRlPEh0dHBSZXNwb25zZTxPYmplY3Q+Pih1cmwsIG9iamVjdCk7XG4gICAgfVxuXG4gICAgZ2V0VmlydHVhbEdyb3Vwcyh1c2VySWQpIHtcbiAgICAgICAgY29uc3QgdXJsID0gYCR7dXJscy50b3BvbG9neS52aXJ0dWFsR3JvdXBOb2Rlc1VybH0ke3VzZXJJZH1gO1xuICAgICAgICByZXR1cm4gdGhpcy5odHRwLmdldDxIdHRwUmVzcG9uc2U8T2JqZWN0Pj4odXJsKTtcbiAgICB9XG59XG4iXX0=