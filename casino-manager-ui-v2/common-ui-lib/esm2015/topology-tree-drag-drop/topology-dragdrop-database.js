/*
 * Topology Drag-Drop Item database, it can build a tree structured Json object.
 * Each node in Json object represents a drag drop item or a category(different item may be nested).
 * If a node is a category(different item may be nested), it has children items and new items
 * can be added under the category(different item may be nested).
 */
import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
/*
 * Node for drag drop item
 */
export class DragDropItemNode {
}
/* Flat drag drop item node with expandable and level information */
export class DragDropItemFlatNode {
}
const ASSIGNEDDATA = new Map();
ASSIGNEDDATA.set(3, 4);
export class TreeDragDropItemDataBase {
    constructor() {
        this.dataChangeAssigned = new BehaviorSubject([]);
        this.dataChangeUnassigned = new BehaviorSubject([]);
        this.dataChangeAG = new BehaviorSubject([]);
        this.dataChangeVG = new BehaviorSubject([]);
        this.initialize();
    }
    data(node) {
        // console.log('data::', node.dataSourceName);
        if (node.dataSourceName === 'assignednode') {
            return this.dataChangeAssigned.value;
        }
        else if (node.dataSourceName === 'unassignednode') {
            return this.dataChangeUnassigned.value;
        }
        else if (node.dataSourceName === 'accessgroup') {
            return this.dataChangeAG.value;
        }
        else if (node.dataSourceName === 'virtualgroup') {
            return this.dataChangeVG.value;
        }
    }
    /**
     * if tree.expandAll called and get an erro of dataNodes we need to set
        this.treeControl.dataNodes = data; in all four group.
     * @param data
     * @param node
     */
    dispatchNextData(data, node) {
        // console.log('dispatchNextData::', data, node.dataSourceName);
        if (node.dataSourceName) {
            if (node.dataSourceName === 'assignednode') {
                this.dataChangeAssigned.next(data);
            }
            else if (node.dataSourceName === 'unassignednode') {
                this.dataChangeUnassigned.next(data);
            }
            else if (node.dataSourceName === 'accessgroup') {
                this.dataChangeAG.next(data);
            }
            else if (node.dataSourceName === 'virtualgroup') {
                this.dataChangeVG.next(data);
            }
        }
    }
    initialize() {
        // Build the tree nodes from Json object. The result is a list of `DragDropItemNode` with nested
        //     file node as children.
        const dataAssigned = this.buildFileTree(ASSIGNEDDATA, 0, 'assignednode');
        this.dataChangeAssigned.next(dataAssigned);
    }
    /*
     * Build the file structure tree. The `value` is the Json object, or a sub-tree of a Json object.
     * The return value is the list of `DragDropItemNode`.
     */
    buildFileTree(obj, level, dataSourceName) {
        return Object.keys(obj).reduce((accumulator, key) => {
            const value = obj[key];
            const node = new DragDropItemNode();
            node.item = key;
            node.dataSourceName = dataSourceName;
            if (value != null) {
                if (typeof value === 'object') {
                    node.children = this.buildFileTree(value, level + 1, node.dataSourceName);
                }
                else {
                    node.item = value;
                }
            }
            return accumulator.concat(node);
        }, []);
    }
    /* Add an item to drag drop list */
    insertItem(parent, name) {
        if (!parent.children) {
            parent.children = [];
        }
        const newItem = { item: name, dataSourceName: parent.dataSourceName };
        parent.children.push(newItem);
        this.dispatchNextData(this.data(newItem), newItem);
        return newItem;
    }
    insertItemAbove(node, name) {
        const parentNode = this.getParentFromNodes(node);
        const newItem = { item: name, dataSourceName: node.dataSourceName };
        if (parentNode != null) {
            parentNode.children.splice(parentNode.children.indexOf(node), 0, newItem);
        }
        else {
            this.data(node).splice(this.data(node).indexOf(node), 0, newItem);
        }
        this.dispatchNextData(this.data(newItem), newItem);
        return newItem;
    }
    insertItemBelow(node, name) {
        const parentNode = this.getParentFromNodes(node);
        const newItem = { item: name, dataSourceName: node.dataSourceName };
        if (parentNode != null) {
            parentNode.children.splice(parentNode.children.indexOf(node) + 1, 0, newItem);
        }
        else {
            this.data(node).splice(this.data(node).indexOf(node) + 1, 0, newItem);
        }
        this.dispatchNextData(this.data(newItem), newItem);
        return newItem;
    }
    getParentFromNodes(node) {
        for (let i = 0; i < this.data(node).length; ++i) {
            const currentRoot = this.data(node)[i];
            const parent = this.getParent(currentRoot, node);
            if (parent != null) {
                return parent;
            }
        }
        return null;
    }
    getParent(currentRoot, node) {
        if (currentRoot.children && currentRoot.children.length > 0) {
            for (let i = 0; i < currentRoot.children.length; ++i) {
                const child = currentRoot.children[i];
                if (child === node) {
                    return currentRoot;
                }
                else if (child.children && child.children.length > 0) {
                    const parent = this.getParent(child, node);
                    if (parent != null) {
                        return parent;
                    }
                }
            }
        }
        return null;
    }
    updateItem(node, name) {
        node.item = name;
        node.dataSourceName = node.dataSourceName;
        this.dispatchNextData(this.data(node), node);
    }
    deleteItem(node) {
        this.deleteNode(this.data(node), node);
        this.dispatchNextData(this.data(node), node);
    }
    copyPasteItem(from, to) {
        // console.log('in copyPasteItem to is', to, 'from is', from);
        const newItem = this.insertItem(to, from.item);
        if (from.children) {
            from.children.forEach(child => {
                this.copyPasteItem(child, newItem);
            });
        }
        return newItem;
    }
    copyPasteItemAbove(from, to) {
        // console.log('in copyPasteItemAbove to is', to, 'from is', from);
        const newItem = this.insertItemAbove(to, from.item);
        if (from.children) {
            from.children.forEach(child => {
                this.copyPasteItem(child, newItem);
            });
        }
        return newItem;
    }
    copyPasteItemBelow(from, to) {
        // console.log('in copyPasteItemBelow to is', to, 'from is', from);
        const newItem = this.insertItemBelow(to, from.item);
        if (from.children) {
            from.children.forEach(child => {
                this.copyPasteItem(child, newItem);
            });
        }
        return newItem;
    }
    deleteNode(nodes, nodeToDelete) {
        const index = nodes.indexOf(nodeToDelete, 0);
        if (index > -1) {
            nodes.splice(index, 1);
        }
        else {
            nodes.forEach(node => {
                if (node.children && node.children.length > 0) {
                    this.deleteNode(node.children, nodeToDelete);
                }
            });
        }
    }
}
TreeDragDropItemDataBase.decorators = [
    { type: Injectable }
];
TreeDragDropItemDataBase.ctorParameters = () => [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9wb2xvZ3ktZHJhZ2Ryb3AtZGF0YWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9jb21tb24tdWktdjIvc3JjL2FwcC90b3BvbG9neS10cmVlLWRyYWctZHJvcC90b3BvbG9neS1kcmFnZHJvcC1kYXRhYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUNILE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUNyQzs7R0FFRztBQUNILE1BQU0sT0FBTyxnQkFBZ0I7Q0FNNUI7QUFFRCxvRUFBb0U7QUFDcEUsTUFBTSxPQUFPLG9CQUFvQjtDQU9oQztBQUVELE1BQU0sWUFBWSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7QUFDL0IsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFHdkIsTUFBTSxPQUFPLHdCQUF3QjtJQXVDakM7UUF0Q0EsdUJBQWtCLEdBQUcsSUFBSSxlQUFlLENBQXFCLEVBQUUsQ0FBQyxDQUFDO1FBQ2pFLHlCQUFvQixHQUFHLElBQUksZUFBZSxDQUFxQixFQUFFLENBQUMsQ0FBQztRQUNuRSxpQkFBWSxHQUFHLElBQUksZUFBZSxDQUFxQixFQUFFLENBQUMsQ0FBQztRQUMzRCxpQkFBWSxHQUFHLElBQUksZUFBZSxDQUFxQixFQUFFLENBQUMsQ0FBQztRQW9DdkQsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3RCLENBQUM7SUFwQ0QsSUFBSSxDQUFDLElBQXNCO1FBQ3ZCLDhDQUE4QztRQUM5QyxJQUFJLElBQUksQ0FBQyxjQUFjLEtBQUssY0FBYyxFQUFFO1lBQ3hDLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQztTQUN4QzthQUFNLElBQUksSUFBSSxDQUFDLGNBQWMsS0FBSyxnQkFBZ0IsRUFBRTtZQUNqRCxPQUFP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QUFLLEdBQUcsQ0FBQyxDQUFDLEVBQUU7WUFDWixLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztTQUMxQjthQUFNO1lBQ0gsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDakIsSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDM0MsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFlBQVksQ0FBQyxDQUFDO2lCQUNoRDtZQUNMLENBQUMsQ0FBQyxDQUFDO1NBQ047SUFDTCxDQUFDOzs7WUFoTUosVUFBVSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBUb3BvbG9neSBEcmFnLURyb3AgSXRlbSBkYXRhYmFzZSwgaXQgY2FuIGJ1aWxkIGEgdHJlZSBzdHJ1Y3R1cmVkIEpzb24gb2JqZWN0LlxuICogRWFjaCBub2RlIGluIEpzb24gb2JqZWN0IHJlcHJlc2VudHMgYSBkcmFnIGRyb3AgaXRlbSBvciBhIGNhdGVnb3J5KGRpZmZlcmVudCBpdGVtIG1heSBiZSBuZXN0ZWQpLlxuICogSWYgYSBub2RlIGlzIGEgY2F0ZWdvcnkoZGlmZmVyZW50IGl0ZW0gbWF5IGJlIG5lc3RlZCksIGl0IGhhcyBjaGlsZHJlbiBpdGVtcyBhbmQgbmV3IGl0ZW1zXG4gKiBjYW4gYmUgYWRkZWQgdW5kZXIgdGhlIGNhdGVnb3J5KGRpZmZlcmVudCBpdGVtIG1heSBiZSBuZXN0ZWQpLlxuICovXG5pbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtCZWhhdmlvclN1YmplY3R9IGZyb20gJ3J4anMnO1xuLypcbiAqIE5vZGUgZm9yIGRyYWcgZHJvcCBpdGVtXG4gKi9cbmV4cG9ydCBjbGFzcyBEcmFnRHJvcEl0ZW1Ob2RlIHtcbiAgICBjaGlsZHJlbjogRHJhZ0Ryb3BJdGVtTm9kZVtdO1xuICAgIGl0ZW06IHN0cmluZztcbiAgICBkYXRhU291cmNlTmFtZTogc3RyaW5nO1xuICAgIG5vZGVJZDogbnVtYmVyO1xuICAgIHBhcmVudE5hbWU6IHN0cmluZztcbn1cblxuLyogRmxhdCBkcmFnIGRyb3AgaXRlbSBub2RlIHdpdGggZXhwYW5kYWJsZSBhbmQgbGV2ZWwgaW5mb3JtYXRpb24gKi9cbmV4cG9ydCBjbGFzcyBEcmFnRHJvcEl0ZW1GbGF0Tm9kZSB7XG4gICAgaXRlbTogc3RyaW5nO1xuICAgIGxldmVsOiBudW1iZXI7XG4gICAgZXhwYW5kYWJsZTogYm9vbGVhbjtcbiAgICBkYXRhU291cmNlTmFtZTogc3RyaW5nO1xuICAgIG5vZGVJZDogbnVtYmVyO1xuICAgIHBhcmVudE5hbWU6IHN0cmluZztcbn1cblxuY29uc3QgQVNTSUdORUREQVRBID0gbmV3IE1hcCgpO1xuQVNTSUdORUREQVRBLnNldCgzLCA0KTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRyZWVEcmFnRHJvcEl0ZW1EYXRhQmFzZSB7XG4gICAgZGF0YUNoYW5nZUFzc2lnbmVkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxEcmFnRHJvcEl0ZW1Ob2RlW10+KFtdKTtcbiAgICBkYXRhQ2hhbmdlVW5hc3NpZ25lZCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RHJhZ0Ryb3BJdGVtTm9kZVtdPihbXSk7XG4gICAgZGF0YUNoYW5nZUFHID0gbmV3IEJlaGF2aW9yU3ViamVjdDxEcmFnRHJvcEl0ZW1Ob2RlW10+KFtdKTtcbiAgICBkYXRhQ2hhbmdlVkcgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PERyYWdEcm9wSXRlbU5vZGVbXT4oW10pO1xuICAgIGRhdGEobm9kZTogRHJhZ0Ryb3BJdGVtTm9kZSk6IERyYWdEcm9wSXRlbU5vZGVbXSB7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdkYXRhOjonLCBub2RlLmRhdGFTb3VyY2VOYW1lKTtcbiAgICAgICAgaWYgKG5vZGUuZGF0YVNvdXJjZU5hbWUgPT09ICdhc3NpZ25lZG5vZGUnKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhQ2hhbmdlQXNzaWduZWQudmFsdWU7XG4gICAgICAgIH0gZWxzZSBpZiAobm9kZS5kYXRhU291cmNlTmFtZSA9PT0gJ3VuYXNzaWduZWRub2RlJykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YUNoYW5nZVVuYXNzaWduZWQudmFsdWU7XG4gICAgICAgIH0gZWxzZSBpZiAoIG5vZGUuZGF0YVNvdXJjZU5hbWUgPT09ICdhY2Nlc3Nncm91cCcpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRhdGFDaGFuZ2VBRy52YWx1ZTtcbiAgICAgICAgfSBlbHNlIGlmICggbm9kZS5kYXRhU291cmNlTmFtZSA9PT0gJ3ZpcnR1YWxncm91cCcpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRhdGFDaGFuZ2VWRy52YWx1ZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIGlmIHRyZWUuZXhwYW5kQWxsIGNhbGxlZCBhbmQgZ2V0IGFuIGVycm8gb2YgZGF0YU5vZGVzIHdlIG5lZWQgdG8gc2V0XG4gICAgICAgIHRoaXMudHJlZUNvbnRyb2wuZGF0YU5vZGVzID0gZGF0YTsgaW4gYWxsIGZvdXIgZ3JvdXAuXG4gICAgICogQHBhcmFtIGRhdGFcbiAgICAgKiBAcGFyYW0gbm9kZVxuICAgICAqL1xuICAgIGRpc3BhdGNoTmV4dERhdGEoZGF0YTogRHJhZ0Ryb3BJdGVtTm9kZVtdLCBub2RlOiBEcmFnRHJvcEl0ZW1Ob2RlKSB7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdkaXNwYXRjaE5leHREYXRhOjonLCBkYXRhLCBub2RlLmRhdGFTb3VyY2VOYW1lKTtcbiAgICAgICAgaWYgKCBub2RlLmRhdGFTb3VyY2VOYW1lKSB7XG4gICAgICAgICAgICBpZiAobm9kZS5kYXRhU291cmNlTmFtZSA9PT0gJ2Fzc2lnbmVkbm9kZScpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRhdGFDaGFuZ2VBc3NpZ25lZC5uZXh0KGRhdGEpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmRhdGFTb3VyY2VOYW1lID09PSAndW5hc3NpZ25lZG5vZGUnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhQ2hhbmdlVW5hc3NpZ25lZC5uZXh0KGRhdGEpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICggbm9kZS5kYXRhU291cmNlTmFtZSA9PT0gJ2FjY2Vzc2dyb3VwJykge1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YUNoYW5nZUFHLm5leHQoZGF0YSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCBub2RlLmRhdGFTb3VyY2VOYW1lID09PSAndmlydHVhbGdyb3VwJykge1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YUNoYW5nZVZHLm5leHQoZGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5pbml0aWFsaXplKCk7XG4gICAgfVxuXG4gICAgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgLy8gQnVpbGQgdGhlIHRyZWUgbm9kZXMgZnJvbSBKc29uIG9iamVjdC4gVGhlIHJlc3VsdCBpcyBhIGxpc3Qgb2YgYERyYWdEcm9wSXRlbU5vZGVgIHdpdGggbmVzdGVkXG4gICAgICAgIC8vICAgICBmaWxlIG5vZGUgYXMgY2hpbGRyZW4uXG4gICAgICAgIGNvbnN0IGRhdGFBc3NpZ25lZCA9IHRoaXMuYnVpbGRGaWxlVHJlZShBU1NJR05FRERBVEEsIDAsICdhc3NpZ25lZG5vZGUnKTtcbiAgICAgICAgdGhpcy5kYXRhQ2hhbmdlQXNzaWduZWQubmV4dChkYXRhQXNzaWduZWQpO1xuXG4gICAgfVxuXG4gICAgLypcbiAgICAgKiBCdWlsZCB0aGUgZmlsZSBzdHJ1Y3R1cmUgdHJlZS4gVGhlIGB2YWx1ZWAgaXMgdGhlIEpzb24gb2JqZWN0LCBvciBhIHN1Yi10cmVlIG9mIGEgSnNvbiBvYmplY3QuXG4gICAgICogVGhlIHJldHVybiB2YWx1ZSBpcyB0aGUgbGlzdCBvZiBgRHJhZ0Ryb3BJdGVtTm9kZWAuXG4gICAgICovXG4gICAgYnVpbGRGaWxlVHJlZShvYmo6IG9iamVjdCwgbGV2ZWw6IG51bWJlciwgZGF0YVNvdXJjZU5hbWU6IHN0cmluZyk6IERyYWdEcm9wSXRlbU5vZGVbXSB7XG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmopLnJlZHVjZTxEcmFnRHJvcEl0ZW1Ob2RlW10+KChhY2N1bXVsYXRvciwga2V5KSA9PiB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IG9ialtrZXldO1xuICAgICAgICAgICAgY29uc3Qgbm9kZSA9IG5ldyBEcmFnRHJvcEl0ZW1Ob2RlKCk7XG4gICAgICAgICAgICBub2RlLml0ZW0gPSBrZXk7XG4gICAgICAgICAgICBub2RlLmRhdGFTb3VyY2VOYW1lID0gZGF0YVNvdXJjZU5hbWU7XG4gICAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUuY2hpbGRyZW4gPSB0aGlzLmJ1aWxkRmlsZVRyZWUodmFsdWUsIGxldmVsICsgMSwgbm9kZS5kYXRhU291cmNlTmFtZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5pdGVtID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gYWNjdW11bGF0b3IuY29uY2F0KG5vZGUpO1xuICAgICAgICB9LCBbXSk7XG4gICAgfVxuXG4gICAgLyogQWRkIGFuIGl0ZW0gdG8gZHJhZyBkcm9wIGxpc3QgKi9cbiAgICBpbnNlcnRJdGVtKHBhcmVudDogRHJhZ0Ryb3BJdGVtTm9kZSwgbmFtZTogc3RyaW5nKTogRHJhZ0Ryb3BJdGVtTm9kZSB7XG4gICAgICAgIGlmICghcGFyZW50LmNoaWxkcmVuKSB7XG4gICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4gPSBbXTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBuZXdJdGVtID0geyBpdGVtOiBuYW1lLCBkYXRhU291cmNlTmFtZTogcGFyZW50LmRhdGFTb3VyY2VOYW1lIH0gYXMgRHJhZ0Ryb3BJdGVtTm9kZTtcbiAgICAgICAgcGFyZW50LmNoaWxkcmVuLnB1c2gobmV3SXRlbSk7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hOZXh0RGF0YSh0aGlzLmRhdGEobmV3SXRlbSksIG5ld0l0ZW0pO1xuICAgICAgICByZXR1cm4gbmV3SXRlbTtcbiAgICB9XG5cbiAgICBpbnNlcnRJdGVtQWJvdmUobm9kZTogRHJhZ0Ryb3BJdGVtTm9kZSwgbmFtZTogc3RyaW5nKTogRHJhZ0Ryb3BJdGVtTm9kZSB7XG4gICAgICAgIGNvbnN0IHBhcmVudE5vZGUgPSB0aGlzLmdldFBhcmVudEZyb21Ob2Rlcyhub2RlKTtcbiAgICAgICAgY29uc3QgbmV3SXRlbSA9IHsgaXRlbTogbmFtZSwgZGF0YVNvdXJjZU5hbWU6IG5vZGUuZGF0YVNvdXJjZU5hbWUgfSBhcyBEcmFnRHJvcEl0ZW1Ob2RlO1xuICAgICAgICBpZiAocGFyZW50Tm9kZSAhPSBudWxsKSB7XG4gICAgICAgICAgICBwYXJlbnROb2RlLmNoaWxkcmVuLnNwbGljZShwYXJlbnROb2RlLmNoaWxkcmVuLmluZGV4T2Yobm9kZSksIDAsIG5ld0l0ZW0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5kYXRhKG5vZGUpLnNwbGljZSh0aGlzLmRhdGEobm9kZSkuaW5kZXhPZihub2RlKSwgMCwgbmV3SXRlbSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kaXNwYXRjaE5leHREYXRhKHRoaXMuZGF0YShuZXdJdGVtKSwgbmV3SXRlbSk7XG4gICAgICAgIHJldHVybiBuZXdJdGVtO1xuICAgIH1cblxuICAgIGluc2VydEl0ZW1CZWxvdyhub2RlOiBEcmFnRHJvcEl0ZW1Ob2RlLCBuYW1lOiBzdHJpbmcpOiBEcmFnRHJvcEl0ZW1Ob2RlIHtcbiAgICAgICAgY29uc3QgcGFyZW50Tm9kZSA9IHRoaXMuZ2V0UGFyZW50RnJvbU5vZGVzKG5vZGUpO1xuICAgICAgICBjb25zdCBuZXdJdGVtID0geyBpdGVtOiBuYW1lLCBkYXRhU291cmNlTmFtZTogbm9kZS5kYXRhU291cmNlTmFtZSB9IGFzIERyYWdEcm9wSXRlbU5vZGU7XG4gICAgICAgIGlmIChwYXJlbnROb2RlICE9IG51bGwpIHtcbiAgICAgICAgICAgIHBhcmVudE5vZGUuY2hpbGRyZW4uc3BsaWNlKHBhcmVudE5vZGUuY2hpbGRyZW4uaW5kZXhPZihub2RlKSArIDEsIDAsIG5ld0l0ZW0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5kYXRhKG5vZGUpLnNwbGljZSh0aGlzLmRhdGEobm9kZSkuaW5kZXhPZihub2RlKSArIDEsIDAsIG5ld0l0ZW0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hOZXh0RGF0YSh0aGlzLmRhdGEobmV3SXRlbSksIG5ld0l0ZW0pO1xuICAgICAgICByZXR1cm4gbmV3SXRlbTtcbiAgICB9XG5cbiAgICBnZXRQYXJlbnRGcm9tTm9kZXMobm9kZTogRHJhZ0Ryb3BJdGVtTm9kZSk6IERyYWdEcm9wSXRlbU5vZGUge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZGF0YShub2RlKS5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgY29uc3QgY3VycmVudFJvb3QgPSB0aGlzLmRhdGEobm9kZSlbaV07XG4gICAgICAgICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLmdldFBhcmVudChjdXJyZW50Um9vdCwgbm9kZSk7XG4gICAgICAgICAgICBpZiAocGFyZW50ICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGdldFBhcmVudChjdXJyZW50Um9vdDogRHJhZ0Ryb3BJdGVtTm9kZSwgbm9kZTogRHJhZ0Ryb3BJdGVtTm9kZSk6IERyYWdEcm9wSXRlbU5vZGUge1xuICAgICAgICBpZiAoY3VycmVudFJvb3QuY2hpbGRyZW4gJiYgY3VycmVudFJvb3QuY2hpbGRyZW4ubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjdXJyZW50Um9vdC5jaGlsZHJlbi5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gY3VycmVudFJvb3QuY2hpbGRyZW5baV07XG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50Um9vdDtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkLmNoaWxkcmVuICYmIGNoaWxkLmNoaWxkcmVuLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gdGhpcy5nZXRQYXJlbnQoY2hpbGQsIG5vZGUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50ICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgdXBkYXRlSXRlbShub2RlOiBEcmFnRHJvcEl0ZW1Ob2RlLCBuYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgbm9kZS5pdGVtID0gbmFtZTtcbiAgICAgICAgbm9kZS5kYXRhU291cmNlTmFtZSA9IG5vZGUuZGF0YVNvdXJjZU5hbWVcbiAgICAgICAgdGhpcy5kaXNwYXRjaE5leHREYXRhKHRoaXMuZGF0YShub2RlKSwgbm9kZSk7XG4gICAgfVxuXG4gICAgZGVsZXRlSXRlbShub2RlOiBEcmFnRHJvcEl0ZW1Ob2RlKSB7XG4gICAgICAgIHRoaXMuZGVsZXRlTm9kZSh0aGlzLmRhdGEobm9kZSksIG5vZGUpO1xuICAgICAgICB0aGlzLmRpc3BhdGNoTmV4dERhdGEodGhpcy5kYXRhKG5vZGUpLCBub2RlKTtcbiAgICB9XG5cbiAgICBjb3B5UGFzdGVJdGVtKGZyb206IERyYWdEcm9wSXRlbU5vZGUsIHRvOiBEcmFnRHJvcEl0ZW1Ob2RlKTogRHJhZ0Ryb3BJdGVtTm9kZSB7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKCdpbiBjb3B5UGFzdGVJdGVtIHRvIGlzJywgdG8sICdmcm9tIGlzJywgZnJvbSk7XG4gICAgICAgIGNvbnN0IG5ld0l0ZW0gPSB0aGlzLmluc2VydEl0ZW0odG8sIGZyb20uaXRlbSk7XG4gICAgICAgIGlmIChmcm9tLmNoaWxkcmVuKSB7XG4gICAgICAgICAgICBmcm9tLmNoaWxkcmVuLmZvckVhY2goY2hpbGQgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuY29weVBhc3RlSXRlbShjaGlsZCwgbmV3SXRlbSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3SXRlbTtcbiAgICB9XG5cbiAgICBjb3B5UGFzdGVJdGVtQWJvdmUoZnJvbTogRHJhZ0Ryb3BJdGVtTm9kZSwgdG86IERyYWdEcm9wSXRlbU5vZGUpOiBEcmFnRHJvcEl0ZW1Ob2RlIHtcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ2luIGNvcHlQYXN0ZUl0ZW1BYm92ZSB0byBpcycsIHRvLCAnZnJvbSBpcycsIGZyb20pO1xuICAgICAgICBjb25zdCBuZXdJdGVtID0gdGhpcy5pbnNlcnRJdGVtQWJvdmUodG8sIGZyb20uaXRlbSk7XG4gICAgICAgIGlmIChmcm9tLmNoaWxkcmVuKSB7XG4gICAgICAgICAgICBmcm9tLmNoaWxkcmVuLmZvckVhY2goY2hpbGQgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuY29weVBhc3RlSXRlbShjaGlsZCwgbmV3SXRlbSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3SXRlbTtcbiAgICB9XG5cbiAgICBjb3B5UGFzdGVJdGVtQmVsb3coZnJvbTogRHJhZ0Ryb3BJdGVtTm9kZSwgdG86IERyYWdEcm9wSXRlbU5vZGUpOiBEcmFnRHJvcEl0ZW1Ob2RlIHtcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ2luIGNvcHlQYXN0ZUl0ZW1CZWxvdyB0byBpcycsIHRvLCAnZnJvbSBpcycsIGZyb20pO1xuICAgICAgICBjb25zdCBuZXdJdGVtID0gdGhpcy5pbnNlcnRJdGVtQmVsb3codG8sIGZyb20uaXRlbSk7XG4gICAgICAgIGlmIChmcm9tLmNoaWxkcmVuKSB7XG4gICAgICAgICAgICBmcm9tLmNoaWxkcmVuLmZvckVhY2goY2hpbGQgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuY29weVBhc3RlSXRlbShjaGlsZCwgbmV3SXRlbSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3SXRlbTtcbiAgICB9XG5cbiAgICBkZWxldGVOb2RlKG5vZGVzOiBEcmFnRHJvcEl0ZW1Ob2RlW10sIG5vZGVUb0RlbGV0ZTogRHJhZ0Ryb3BJdGVtTm9kZSkge1xuICAgICAgICBjb25zdCBpbmRleCA9IG5vZGVzLmluZGV4T2Yobm9kZVRvRGVsZXRlLCAwKTtcbiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgIG5vZGVzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBub2Rlcy5mb3JFYWNoKG5vZGUgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChub2RlLmNoaWxkcmVuICYmIG5vZGUuY2hpbGRyZW4ubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlbGV0ZU5vZGUobm9kZS5jaGlsZHJlbiwgbm9kZVRvRGVsZXRlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbn0iXX0=